name: Deploy Diapsa Frontend

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
            host: ${{ secrets.SERVER_HOST }}
            username: ${{ secrets.SERVER_USER }}
            key: ${{ secrets.SERVER_SSH_KEY }}
            script: |
                set -e

                export NVM_DIR="$HOME/.nvm"
                [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

                nvm use 24

                cd ${{ secrets.APP_PATH }}

                echo "Pulling latest code"
                git pull origin main

                echo "Installing dependencies"
                npm install

                echo "Building Next.js"
                npm run build

                echo "Reloading PM2"
                pm2 reload diapsa-frontend --update-env

# Pendientes
# cache de node_modules
# staging branch
# rollback autom√°tico
# healthcheck post-deploy